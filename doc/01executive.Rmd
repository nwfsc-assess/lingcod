```{r executive, echo = FALSE}
assessmentyear <- as.numeric(format(Sys.Date(), "%Y")) - 1
area_long <- paste0(tolower(params$area), "ern ")
n_stocks <- xfun::numbers_to_words( length(get_groups(info_groups)))
spr_peak_yr <-  model$sprseries$Yr[model$sprseries$SPR_report == max(model$sprseries$SPR_report[model$sprseries$Yr < model$endyr])]
spr_peak <- round(max(model$sprseries$SPR_report[model$sprseries$Yr < model$endyr]), 2)
```
# Executive summary{-}

## Stock{-}

```{asis executive-summary-stock, echo = TRUE}
This assessment reports the status of `r spp` (_`r spp.sci`_)
off the `r area_long` `r coast` coast
using data through `r assessmentyear`.
`r Spp` were modeled as `r n_stocks` `r ifelse(n_stocks > 1, "stocks", "stock")` and
this document contains summary information on the species and
detailed information for the `r area_long` stock.
It does not include catches from the Alaskan, Canadian, or Mexican populations and
assumes that these flanking populations do not contribute to the stock being assessed here.
```

## Catches{-}

The first known records of `r spp` landings date back to the late 1800s
(Figure \@ref(fig:es-catch)).
Catch reconstructions for these early landings were informed by state resources and
recent landings (Table \@ref(tab:removalsES)) were available available from PacFIN and RecFIN.
Commercial discards were modeled using discard rate and length compositions to estimate retention curves.
Recreational catches included estimates of dead discards in the landings data
(Table \@ref(tab:removalsES)). Discard mortality was assumed to be 50\% 
for commercial trawl and 7\% for commercial fixed-gear and recreational fleets.

```{r, exsum-text-commfleetstructure, echo = FALSE, results = "asis"}
sa4ss::read_child("catch-comm-fleetstructure.Rmd")
```

```{r es-landings-table, results = "asis"}
table_labels <- utils::read.csv(
  file.path("..", mod_loc, "tables", "table_labels.csv")
)
eslandingsinfo <- utils::read.csv(
  file.path("..", mod_loc, "tables", "a_Catches_ES.csv")
)
eslandingsinfo <- round(eslandingsinfo, 0) # round all catch values to 0 digits

colnames(eslandingsinfo) <- gsub("^X", "", colnames(eslandingsinfo))
matches <- match(colnames(eslandingsinfo), get_fleet(col = "fleet"))
colnames(eslandingsinfo) <- ifelse(is.na(matches),
  gsub("([a-zA-Z])\\.([a-zA-Z])", "\\1 \\L\\2", perl = TRUE, colnames(eslandingsinfo)),
  gsub("^([a-z])", "\\U\\1", perl = TRUE, get_fleet(col = "label_short")[matches])
)
sa4ss::table_format(
  eslandingsinfo,
  caption = table_labels[table_labels[["label"]] == "removalsES", "caption"],
  label = table_labels[table_labels[["label"]] == "removalsES", "label"],
)
```

![Landings plus dead discards (mt) by fleet as input and estimated in the base model.\label{fig:es-catch}](`r paste0('"', filein = file.path("..", mod_loc, "plots", "catch16 landings + dead discards.png"), '"')`){width=100% height=100% alt="."}

\clearpage

## Data and assessment{-}

This assessment uses the Stock Synthesis fisheries stock assessment model
version `r strsplit(model$SS_version,";")[[1]][1]`.
`r Spp` has been modeled using various age-structured forward-projection models since the mid 1990s and
was most recently assessed in 2017 [@haltuch2019lingcod].
Data included in the base model provided information on
landings for each commercial and recreational fleet,
commercial discards, available from the West Coast Groundfish Observer Program;
relative abundance as informed by the
Triennial Survey,
West Coast Groundfish Bottom Trawl Survey,
commercial trawl fishery, and
each recreational fishery;
length and age compositions, available from the previous sources as well as
research done by L. Lam.

```{asis, opts.label = "north"}
For this northern area,
information on relative abundance was also available from the Oregon fixed gear fleet.
```
```{asis, opts.label = "south"}
For this southern area,
information on abundance, length, and age was also available from the Hook and Line Survey.
The final model included ages from just the West Coast Groundfish Bottom Trawl Survey because of conflicts between age- and length-composition data.
```

Age data were explored using conditional-age-at-length rather than marginal ages and
all length data were modeled as sex-specific compositions for fish that were sexed and as combined sex for fish that were measured but not sexed.
Unsexed fish that were aged were not included in this assessment.

Key parameters related to productivity were estimated and
parameters related to growth and mortality were sex specific and time invariant.
Annual recruitment deviations started in
`r model$recruitpars%>%dplyr::filter(type == "Main_RecrDev")%>%dplyr::pull(Yr) %>% min`,
just prior to the availability of reliable length- and age-composition data.
Selectivity for each fleet was modeled using a double-normal function of length that allowed for dome or asymptotic shapes that were supported by the data.
Time blocks were used for selectivity and retention to account for management changes.

A wide range of sensitivity runs were conducted to explore various
model structures related to biology and recruitment,
changes the data that were included in the model,
ways in which selectivity was parameterized,
etc.
Results were sensitive to the addition and subtraction of age data,
which typically changed the scale of the population and estimates of key productivity parameters.

## Stock biomass{-}

```{asis, opts.label = "north"}
The stock biomass is currently trending downwards, though the rate of the decline is highly uncertain
(Figure \@ref(fig:es-ssb)).
And, although it is currently declining, it estimated to have been above the management target since
the late 1990s and never to have been below the minimum stock size threshold
(Figure \@ref(fig:es-depl)).
```
```{asis, opts.label = "south"}
The stock biomass is currently trending upwards, though the rate of the increase is highly uncertain
(Figure \@ref(fig:es-ssb)).
Uncertainty in the initial stock size is vast and this uncertainty is carried forward until approximately the
early 1980s when more informative data are available.
The current estimated biomass is below, but close to, the management target with the uncertainty in this estimate
spanning well above and below the management target and the minimum stock size threshold
(Figure \@ref(fig:es-depl)).
```

```{r, results = "asis"}
tabb <- utils::read.csv(
  file.path("..", mod_loc, "tables", "b_SSB_ES.csv")
)
tabb[, grep("Interval", colnames(tabb))] <- 
round(tabb[, grep("Interval", colnames(tabb))], 3)
colnames(tabb) <- gsub(
  "\\.[1-9]$", "",
  gsub(
  "\\.\\.mt\\.", " (mt)",
  gsub("([a-z])\\.([A-Za-z])", "\\1 \\L\\2", perl = TRUE, colnames(tabb))
))
sa4ss::table_format(
  tabb,
  longtable = FALSE,
  caption = table_labels[table_labels[["label"]] == "ssbES", "caption"],
  label = table_labels[table_labels[["label"]] == "ssbES", "label"],
)
```

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path("..", mod_loc, "plots",
"ts7_Spawning_biomass_(mt)_with_95_asymptotic_intervals_intervals.png"), 
caption = "Estimated time series of spawning output (circles and line: median; light broken lines: 95 percent intervals) for the base model",
label = 'es-ssb')
```

```{r, results = 'asis'}
sa4ss::add_figure(
filein = dir(file.path("..", mod_loc, "plots"), pattern = "ts9_.+_intervals", full.names = TRUE), 
caption = "Estimated time series of fraction of unfished spawning output (circles and line: median; light broken lines: 95 percent intervals) for the base model",
label = 'es-depl')
```

\clearpage

## Recruitment{-}

`r Spp` appear to have moderate variability in estimates of recruitment with
recruitment variability ($\sigma_R$) fixed at
`r model$parameters[model$parameters$Label=="SR_sigmaR","Value"]`
(Figures \@ref(fig:es-recruits) and \@ref(fig:es-rec-devs)).
Given the pandemic and the lack of recent survey information,
recruitment was not estimable for the next to last year of the model
(Table \@ref(tab:recrES)).
If the survey in 2019 would have been conducted,
then 2019 recruitment would have been different from that predicted from the stock-recruitment curve and
perhaps less uncertain.
Though, `r spp` are not seen as age-0 fish in any data set in appreciable quantities, and thus,
the terminal year of recruitment is never estimated.
The last large recruitment event for this stock occurred in 2013 and
a smaller event may have also occurred within the last half-decade though its magnitude is more uncertain.

```{r, results = "asis"}
tabc <- utils::read.csv(
  file.path("..", mod_loc, "tables", "c_Recr_ES.csv")
)
tabc[, "Lower.Interval"] <- round(tabc[, "Lower.Interval"], 2)
tabc[, 5:NCOL(tabc)] <- round(tabc[, 5:NCOL(tabc)], 4)
colnames(tabc) <- gsub(
  "\\.[1-9]$", "",
  gsub(
  "\\.\\.mt\\.", " (mt)",
  gsub("([a-z])\\.([A-Za-z])", "\\1 \\L\\2", perl = TRUE, colnames(tabc))
))
sa4ss::table_format(
  tabc,
  caption = table_labels[table_labels[["label"]] == "recrES", "caption"],
  label = table_labels[table_labels[["label"]] == "recrES", "label"],
)
```

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path("..", mod_loc, "plots", "ts11_Age-0_recruits_(1000s)_with_95_asymptotic_intervals.png"), 
caption = "Estimated time series of age-0 recruits (1000s) for the base model with 95 percent intervals",
label = 'es-recruits')
```

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path("..", mod_loc, "plots", "recdevs2_withbars.png"), 
caption = "Estimated time series of recruitment deviations",
label = 'es-rec-devs')
```

\clearpage

## Exploitation status{-}

```{asis, opts.label = "north"}
The harvest rate was estimated to have never been above the target proxy harvest rate
(Table \@ref(tab:exploitES); Figure \@ref(fig:es-1-spr)).
Recent estimates of fishing intensity indicate stability within the fishery and 
are close to pre-1950 estimates. The relative fishing intensity is estimated to have 
peaked in `r spr_peak_yr` at a value of (1 - SPR)/(1-SPR45\%) = `r spr_peak`.
```
```{asis, opts.label = "south"}
The stock was estimated to have been harvested above the target proxy harvest rate 
from the 1970s to approximately the late 1990s and again in the early 2000s
(Figure \@ref(fig:es-1-spr)). The relative fishing intensity is estimated to have 
peaked in `r spr_peak_yr` at a value of (1 - SPR)/(1-SPR45\%) = `r spr_peak`.
Recent estimates of harvest have all been below the target proxy harvest rate and
the estimate of fishing intensity for the terminal year was the lowest estimated since 2011
(Table \@ref(tab:exploitES)).
```

```{r, results = "asis"}
tabd <- utils::read.csv(
  file.path("..", mod_loc, "tables", "d_SPR_ES.csv")
)
tabd[, -1] <- round(tabd[, -1], 4)
colnames(tabd)[2] <- "Relative fishing intensity"
colnames(tabd) <- gsub(
  "\\.[1-9]$", "",
  gsub(
  "\\.\\.mt\\.", " (mt)",
  gsub("([a-z])\\.([A-Za-z])", "\\1 \\L\\2", perl = TRUE, colnames(tabd))
))
sa4ss::table_format(
  tabd,
  caption = "Estimated recent trend in relative fishing intensity and exploitation rate with associated 95\\% intervals. Fishing intensity is (1-SPR)/(1-SPR45\\%), where SPR is the spawning potential and SPR45\\% = 0.45 is the SPR target. Exploitation rate is annual total dead catch divided age 3+ biomass.",
  label = table_labels[table_labels[["label"]] == "exploitES", "label"],
)
```

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path("..", mod_loc, "plots", "SPR3_ratiointerval.png"), 
caption = "Estimated relative fishing intensity = (1-SPR)/(1-SPR45%) with 95% intervals, where SPR is the spawning potential and SPR45% = 0.45 is the SPR target. The red horizontal line at 1.0 indicates fishing intensity equal to the target and values above this reflect harvest in excess of the proxy harvest rate.",
label = 'es-1-spr')
```

\clearpage

## Reference points{-}

```{asis, opts.label = "north"}
The 2021 spawning biomass relative to unfished equilibrium biomass (fraction unfished) was estimated to be well above the management target, even the lower interval was estimated to be above the target
(Table \@ref(tab:referenceES); Figures \@ref(fig:es-phase) and \@ref(fig:es-yield)).
```
```{asis, opts.label = "south"}
The 2021 spawning biomass relative to unfished equilibrium biomass (fraction unfished) was estimated to be close to the management target
(Table \@ref(tab:referenceES); Figures \@ref(fig:es-phase) and \@ref(fig:es-yield)).
The uncertainty in this estimate spans well below any estimated value and nearly reaches 1.0, which would indicate the stock is at unfished levels
(Figure \@ref(fig:es-phase)).
```
```{r, results = "asis"}
tabe <- utils::read.csv(
  file.path("..", mod_loc, "tables", "e_ReferencePoints_ES.csv")
)
tabe[, -1] <- round(tabe[, -1], 4)
colnames(tabe)[1] <- "Reference point"
colnames(tabe) <- gsub(
  "\\.[1-9]$", "",
  gsub(
  "\\.\\.mt\\.", " (mt)",
  gsub("([a-z])\\.([A-Za-z])", "\\1 \\L\\2", perl = TRUE, colnames(tabe))
))
tabe[which(is.na(tabe[, 2])), -1] <- "-"
sa4ss::table_format(
  tabe,
  escape = FALSE,
  longtable = FALSE,
  align = c("l", rep("r", 3)),
  caption = table_labels[table_labels[["filename"]] == "e_ReferencePoints_ES.csv", "caption"],
  label = table_labels[table_labels[["filename"]] == "e_ReferencePoints_ES.csv", "label"],
)
```

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path("..", mod_loc, "plots", "SPR4_phase.png"), 
caption = "Phase plot of estimated 1-SPR versus fraction unfished for the base model",
label = 'es-phase')
```

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path("..", mod_loc, "plots", "yield2_yield_curve_with_refpoints.png"), 
caption = "Equilibrium yield curve for the base case model. Values are based on the 2020
fishery selectivities",
label = 'es-yield')
```

\clearpage

## Management performance{-}

In the last ten years, the annual catch limit has been below the overfishing limit and acceptable biological catch
(Table \@ref(tab:referenceES)).
Furthermore, landings and catches (i.e., total mortality) have been well below the annual catch limit.

```{r, results = "asis"}
management_oflabcacl <- utils::read.csv(file.path("..", "tables", "management-oflabcacl.csv"))
tabf <- utils::read.csv(
  file.path("..", mod_loc, "tables", "f_Manage_ES.csv")
)
tabf[, 2:4] <- management_oflabcacl %>%
  dplyr::filter(area == params$area) %>%
  dplyr::filter(Year %in% tabf[, 1]) %>%
  dplyr::select(-area, -Year)
colnames(tabf) <- gsub(
  "\\.[1-9]$", "",
  gsub(
  "\\.\\.mt\\.", " (mt)",
  gsub("([a-z])\\.([A-Za-z])", "\\1 \\L\\2", perl = TRUE, colnames(tabf))
))
sa4ss::table_format(
  tabf,
  digits = 2,
  align = "r",
  caption = table_labels[table_labels[["filename"]] == "f_Manage_ES.csv", "caption"],
  label = table_labels[table_labels[["filename"]] == "f_Manage_ES.csv", "label"],
)
```

\clearpage

## Unresolved problems and major uncertainties{-}

The base-model configuration was developed with the goal of balancing parsimony with realism and fitting the data.
To achieve parsimony, some simplification of the model structure was assumed relative to known processes,
which may impact the interpretation and fit to specific data sets.
For example, a clear break between the northern and southern stock at Cape Mendocino is unrealistic but
we do not currently have the resources necessary to add spatial dynamics to the stock assessment or
estimate the level of overlap between the stocks.

Patterns of sex-specific selectivity were apparent in the data, particularly for the fishing fleets.
Unfortunately, we were unable to configure the model in such a way that the model fit all data sources equally as well
as the base-model configuration when attempting to account for these patterns.

Uncertainty in parameter estimates are quite large relative to recent assessments because of the choice to estimate
both natural mortality and steepness.
Recent work has shown the utility of estimating both parameters with respect to management reference points, and although estimates provided in this document are imprecise,
we predict that they are less biased than if the model would have been configured with one or more of these parameters as fixed inputs rather than estimated.
Estimating both parameters led to counter-intuitive differences in estimates of natural mortality between the two areas.
Hopefully, future work on parameterizing selectivity will lead to more precise estimates of male and female
natural mortality given the life history of this species, specifically the nest-guarding behavior of males.

## Decision table{-}

The forecast of stock abundance and yield was developed using the base model
(Table \@ref(tab:es-forecastprojections)).
The total catches for the first two years of the forecast period were based on values provided by the \glsentrylong{gmt} and
a 40:60 split between the two commercial fleets.
These assumed removals are likely higher than what the true removals will be for this year and next year but
their influence on the assessment of stock status and future removals are limited.

The axes of uncertainty in the decision table (Table \@ref(tab:es-decision)) are based on
the uncertainty in `r ifelse(params$area == "north", "sex-specific selectivity and the removal of fishery ages", "female natural mortality")`.
Three alternative catch streams were created for the decision table (Table \@ref(tab:es-decision)).
The first option uses recent average catch,
the second option uses a $P^*$ of 0.40, and
the third option uses a $P^*$ of 0.45.

\clearpage

```{r, results = 'asis'}
ignore <- table_projections(model, label = "es-forecastprojections")
cat(ignore)
```

```{r, results = "asis"}
decisiontable <- append(
  x = readLines(file.path("..", mod_loc, "decision_table.tex")),
  values = c("\\caption{\\label{tab:es-decision}Decision table summary of 10-year projections based on recent average catch for the first two years of the projection, alternative states of nature (columns), and management assumptions (asm.; rows) based on recent average catch and annual catch limits (ACLs) defined using an estimate of uncertainty (i.e., $P^*$) of 0.40 and 0.45. Catch and resulting fraction unfished are colored relatively with lighter colors representing lower values.}"),
  after = 1
)
cat(decisiontable)
```

\clearpage

## Regional management considerations{-}

```{r results = "asis"}
sa4ss::read_child("regional-management-considerations.Rmd")
```

## Research and data needs{-}

```{r results = "asis"}
sa4ss::read_child("research-and-data-needs.Rmd")
```
